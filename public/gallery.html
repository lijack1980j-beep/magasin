<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Glitch Signal – Project Gallery</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />

  <style>
    .gs-modal{ position: fixed; inset:0; z-index: 9999; display:none; }
    .gs-modal.is-open{ display:block; }

    .gs-modal-backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }

    .gs-modal-card{
      position: relative;
      width: min(920px, 94vw);
      margin: 5vh auto 0;
      background: rgba(18,18,18,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 16px;
      color:#fff;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }

    .gs-modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .gs-modal-x{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:#fff;
      border-radius: 10px;
      padding: 8px 12px;
      cursor:pointer;
      font-weight: 700;
      line-height: 1;
    }
    .gs-modal-x:hover{ border-color: rgba(0,188,212,.5); }

    .gs-modal-body{ padding-top: 12px; }

    .gs-modal-section{
      padding: 14px 0;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .gs-modal-section:last-child{ border-bottom:none; }

    .gs-modal-mainimg img{
      width:100%;
      height: 340px;
      object-fit: cover;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      display:block;
    }
    @media (max-width: 768px){
      .gs-modal-mainimg img{ height: 220px; }
    }

    .gs-modal-gallery{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .gs-modal-gallery img{
      width:100%;
      height:140px;
      object-fit: cover;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      display:block;
    }

    .gs-btn-row{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .gs-btn{
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff;
      cursor:pointer;
      font-weight: 600;
      font-family: Poppins, sans-serif;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }
    .gs-btn:hover{ transform: translateY(-1px); border-color: rgba(0,188,212,.45); }
    .gs-btn.primary{
      background: rgba(0,188,212,0.14);
      border-color: rgba(0,188,212,0.30);
    }
    .gs-btn.danger{
      background: rgba(255,0,80,0.14);
      border-color: rgba(255,0,80,0.28);
    }

    .gs-buy{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .gs-price{
      font-weight: 800;
      font-size: 22px;
      color: var(--accent-color, #00bcd4);
    }

    .gs-contact-wrap{ display:none; }
    .gs-contact-wrap.is-open{ display:block; }

    .gs-field label{ display:block; margin: 10px 0 6px; opacity:.9; font-size:.95rem; }
    .gs-field input, .gs-field textarea{
      width:100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color:#fff;
      outline:none;
      font-family: Poppins, sans-serif;
    }
    .gs-small-muted{ opacity:.75; font-size: .92rem; }
  </style>
</head>

<body>
  <header class="navbar">
    <div class="container nav-container">
      <div class="logo"><a href="/index.html">Glitch&nbsp;Signal</a></div>

      <nav id="nav-menu" class="nav-links">
        <a href="/index.html#about">About</a>
        <a href="/index.html#services">Services</a>
        <a href="/gallery.html">Gallery</a>
        <a href="/index.html#contact">Contact</a>
        <a href="#" id="cart-link">Cart (<span id="cart-count">0</span>)</a>
        <a href="/admin.html">Admin</a>
      </nav>

      <button id="nav-toggle" aria-label="Toggle navigation">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </button>
    </div>
  </header>

  <section class="gallery-hero">
    <div class="container">
      <h1 class="gallery-title">Project Gallery</h1>
      <p class="gallery-subtitle">Browse projects by category. Filter + search to find what you need.</p>

      <div class="gallery-controls">
        <input id="searchInput" class="gallery-search" type="search" placeholder="Search projects (title, tags, description)..." />
        <select id="sortSelect" class="gallery-sort">
          <option value="new">Newest</option>
          <option value="stars">Most stars</option>
          <option value="az">A → Z</option>
        </select>
      </div>

      <div id="filters" class="gallery-filters"></div>
    </div>
  </section>

  <main class="gallery-main">
    <div class="container">
      <div id="galleryRoot"></div>
      <p id="galleryStatus" class="gallery-status"></p>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2019–2025 Glitch Signal. All rights reserved.</p>
    </div>
  </footer>

  <!-- ✅ Modal -->
  <div id="gsProjectModal" class="gs-modal" aria-hidden="true">
    <div class="gs-modal-backdrop" id="gsModalBackdrop"></div>

    <div class="gs-modal-card" role="dialog" aria-modal="true" aria-labelledby="gsModalTitle">
      <div class="gs-modal-head">
        <h3 id="gsModalTitle" style="margin:0;">Project Details</h3>
        <button id="gsModalCloseX" type="button" class="gs-modal-x">✕</button>
      </div>

      <div class="gs-modal-body">
        <div class="gs-modal-section" style="padding-top:0;">
          <h2 id="gsModalName" style="margin:0 0 6px; font-size: 1.4rem;">—</h2>
          <div class="gs-small-muted" id="gsModalMeta">—</div>
        </div>

        <!-- ✅ Main image ABOVE description -->
        <div class="gs-modal-section" style="padding-top:0;">
          <div id="gsModalMainImage" class="gs-modal-mainimg"></div>
        </div>

        <div class="gs-modal-section" style="padding-top:0;">
          <p id="gsModalDesc" style="margin:0;opacity:.85;">—</p>
        </div>

        <!-- ✅ Extra images BELOW description -->
        <div class="gs-modal-section">
          <h4 style="margin:0 0 10px;">More Pictures</h4>
          <div id="gsModalGallery" class="gs-modal-gallery"></div>
        </div>

        <div class="gs-modal-section">
          <div class="gs-buy">
            <div>
              <div class="gs-small-muted">Price</div>
              <div id="gsModalPrice" class="gs-price">—</div>
            </div>

            <div class="gs-btn-row">
              <button id="gsModalBuyBtn" class="gs-btn primary" type="button">Buy / Add to Cart</button>
              <button id="gsModalContactBtn" class="gs-btn" type="button">Contact</button>
              <button id="gsModalCancelBtn" class="gs-btn danger" type="button">Close</button>
            </div>
          </div>
        </div>

        <!-- Contact form (hidden until Contact click) -->
        <div class="gs-modal-section gs-contact-wrap" id="gsContactWrap">
          <h4 style="margin:0 0 6px;">Send your info</h4>
          <p class="gs-small-muted" style="margin:0 0 10px;">
            Fill the form and I will receive it (via /api/contact).
          </p>

          <form id="gsModalContactForm">
            <input type="hidden" id="gsModalProductId" />
            <input type="hidden" id="gsModalProductTitle" />

            <div class="gs-field">
              <label for="gsModalYourName">Your Name</label>
              <input id="gsModalYourName" required placeholder="Full name" />
            </div>

            <div class="gs-field">
              <label for="gsModalYourEmail">Email</label>
              <input id="gsModalYourEmail" type="email" required placeholder="you@example.com" />
            </div>

            <div class="gs-field">
              <label for="gsModalYourMessage">Message</label>
              <textarea id="gsModalYourMessage" rows="4" required placeholder="Tell me what you need..."></textarea>
            </div>

            <div class="gs-btn-row" style="margin-top:12px;">
              <button id="gsModalSendBtn" class="gs-btn primary" type="submit">Send</button>
              <button id="gsModalCloseContactBtn" class="gs-btn" type="button">Hide Form</button>
              <span id="gsModalStatus" class="gs-small-muted" style="margin-left:auto;"></span>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- scripts -->
  <script src="/script.js"></script>
  <script src="/store-data.js"></script>
  <script type="module" src="/gallery.js"></script>

  <!-- ✅ ONLY ONE modal script -->
  <script>
  (() => {
    const modal = document.getElementById("gsProjectModal");
    const backdrop = document.getElementById("gsModalBackdrop");
    const closeX = document.getElementById("gsModalCloseX");
    const closeBtn = document.getElementById("gsModalCancelBtn");

    const nameEl = document.getElementById("gsModalName");
    const metaEl = document.getElementById("gsModalMeta");
    const descEl = document.getElementById("gsModalDesc");
    const priceEl = document.getElementById("gsModalPrice");

    const mainImgEl = document.getElementById("gsModalMainImage");
    const galleryEl = document.getElementById("gsModalGallery");

    const buyBtn = document.getElementById("gsModalBuyBtn");

    const contactBtn = document.getElementById("gsModalContactBtn");
    const contactWrap = document.getElementById("gsContactWrap");
    const hideContactBtn = document.getElementById("gsModalCloseContactBtn");

    const statusEl = document.getElementById("gsModalStatus");
    const sendBtn = document.getElementById("gsModalSendBtn");

    const pidEl = document.getElementById("gsModalProductId");
    const ptitleEl = document.getElementById("gsModalProductTitle");

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function lockScroll(lock){
      document.body.style.overflow = lock ? "hidden" : "";
    }

    function openModal(project){
      contactWrap.classList.remove("is-open");
      statusEl.textContent = "";
      if (sendBtn) sendBtn.disabled = false;

      lockScroll(true);
      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");

      const title = project.title || "Untitled";
      nameEl.textContent = title;

      const cat = String(project.category || "other").toUpperCase();
      const tags = Array.isArray(project.tags) ? project.tags.join(", ") : "";
      metaEl.textContent = tags ? `${cat} • ${tags}` : cat;

      const cover = project.cover_image_url || "/images/hero-image.png";
      mainImgEl.innerHTML = `
        <img src="${esc(cover)}" alt="${esc(title)}"
             onerror="this.onerror=null;this.src='/images/hero-image.png';" />
      `;

      descEl.textContent = project.description || project.desc || "";

      const extra = (Array.isArray(project.extra_images) ? project.extra_images : []).filter(Boolean);
      galleryEl.innerHTML = extra.length
        ? extra.map(src => `
            <img src="${esc(src)}" alt="${esc(title)}"
                 onerror="this.onerror=null;this.src='/images/hero-image.png';" />
          `).join("")
        : `<div class="gs-small-muted">No extra pictures.</div>`;

      const priceText =
        (project.price === "" || project.price == null || isNaN(Number(project.price)))
          ? "—"
          : `$${Number(project.price).toFixed(2)}`;
      priceEl.textContent = priceText;

      pidEl.value = project.id || "";
      ptitleEl.value = title;

      buyBtn.onclick = () => {
        if (typeof window.addToCart === "function") {
          window.addToCart({
            id: String(project.id || ""),
            title,
            price: String(project.price ?? ""),
            category: String(project.category || "")
          });
          if (typeof window.updateCartCount === "function") window.updateCartCount();
          alert("Added to cart ✅");
        } else {
          contactWrap.classList.add("is-open");
          document.getElementById("gsModalYourMessage")?.focus();
        }
      };
    }

    function closeModal(){
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
      lockScroll(false);
      document.getElementById("gsModalContactForm")?.reset();
      contactWrap.classList.remove("is-open");
      statusEl.textContent = "";
      if (sendBtn) sendBtn.disabled = false;
    }

    backdrop.addEventListener("click", closeModal);
    closeX.addEventListener("click", closeModal);
    closeBtn.addEventListener("click", closeModal);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("is-open")) closeModal();
    });

    contactBtn.addEventListener("click", () => {
      contactWrap.classList.toggle("is-open");
      if (contactWrap.classList.contains("is-open")) {
        document.getElementById("gsModalYourName")?.focus();
      }
    });
    hideContactBtn.addEventListener("click", () => {
      contactWrap.classList.remove("is-open");
    });

    // ✅ open modal by clicking any card (uses gallery.js state)
    document.addEventListener("click", (e) => {
      const card = e.target.closest(".g-card");
      if (!card) return;

      const id = card.getAttribute("data-id");
      if (!id) return;

      const projects = window.__GS_STATE__?.projects || [];
      const project = projects.find(p => String(p.id) === String(id));
      if (!project) return;

      openModal(project);
    });

    // submit contact
    document.getElementById("gsModalContactForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = {
        name: document.getElementById("gsModalYourName").value.trim(),
        email: document.getElementById("gsModalYourEmail").value.trim(),
        message: document.getElementById("gsModalYourMessage").value.trim(),
        productId: pidEl.value,
        productTitle: ptitleEl.value
      };

      if (!payload.name || !payload.email || !payload.message) {
        return alert("Please fill name, email, and message.");
      }

      statusEl.textContent = "Sending...";
      sendBtn.disabled = true;

      try {
        const res = await fetch("/api/contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const out = await res.json().catch(() => ({}));
        if (!res.ok || !out.ok) {
          statusEl.textContent = "Failed";
          sendBtn.disabled = false;
          return alert("Send failed: " + (out.error || "unknown"));
        }

        statusEl.textContent = "Sent ✅";
        alert("Message sent ✅");
        closeModal();
      } catch (err) {
        statusEl.textContent = "Failed";
        sendBtn.disabled = false;
        alert("Network error: " + err.message);
      }
    });
  })();
  </script>
</body>
</html>
