<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Glitch Signal – Project Gallery</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="navbar">
    <div class="container nav-container">
      <div class="logo"><a href="/index.html">Glitch&nbsp;Signal</a></div>

      <nav id="nav-menu" class="nav-links">
        <a href="/index.html#about">About</a>
        <a href="/index.html#services">Services</a>
        <a href="/gallery.html">Gallery</a>
        <a href="/index.html#contact">Contact</a>
        <a href="#" id="cart-link">Cart (<span id="cart-count">0</span>)</a>
        <a href="/admin.html">Admin</a>
      </nav>

      <button id="nav-toggle" aria-label="Toggle navigation">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </button>
    </div>
  </header>

  <section class="gallery-hero">
    <div class="container">
      <h1 class="gallery-title">Project Gallery</h1>
      <p class="gallery-subtitle">Browse projects by category. Filter + search to find what you need.</p>

      <div class="gallery-controls">
        <input id="searchInput" class="gallery-search" type="search" placeholder="Search projects (title, tags, description)..." />
        <select id="sortSelect" class="gallery-sort">
          <option value="new">Newest</option>
          <option value="stars">Most stars</option>
          <option value="az">A → Z</option>
        </select>
      </div>

      <div id="filters" class="gallery-filters"></div>
    </div>
  </section>

  <main class="gallery-main">
    <div class="container">
      <div id="galleryRoot"></div>
      <p id="galleryStatus" class="gallery-status"></p>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2019–2025 Glitch Signal. All rights reserved.</p>
    </div>
  </footer>

  <!-- ======================================================
       1) PROJECT DETAILS MODAL (NO CONTACT FORM INSIDE)
  ======================================================= -->
  <div id="gsProjectModal" class="gs-modal" style="display:none;">
    <div class="gs-modal-backdrop" id="gsModalBackdrop"></div>

    <div class="gs-modal-card gs-modal-card--big" role="dialog" aria-modal="true" aria-labelledby="gsModalTitle">
      <div class="gs-modal-head">
        <h3 id="gsModalTitle" style="margin:0;">Project Details</h3>
        <button id="gsModalCloseX" type="button" class="gs-modal-x">✕</button>
      </div>

      <div class="gs-modal-body">
        <!-- Name + Description -->
        <div class="gs-modal-section">
          <h4 id="gsModalName" style="margin:0 0 6px;">—</h4>
          <p id="gsModalDesc" style="margin:0;opacity:.85;">—</p>
        </div>

        <!-- Pictures -->
        <div class="gs-modal-section">
          <h4 style="margin:0 0 10px;">Pictures</h4>
          <div id="gsModalGallery" class="gs-modal-gallery"></div>
        </div>

        <!-- Buy -->
        <div class="gs-modal-section gs-modal-buy">
          <div>
            <div style="opacity:.85;font-size:14px;">Price</div>
            <div id="gsModalPrice" style="font-weight:700;font-size:20px;">—</div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <button id="gsModalBuyBtn" class="gs-btn gs-btn--primary" type="button">Buy / Add to Cart</button>
            <button id="gsOpenContactBtn" class="gs-btn gs-btn--ghost" type="button">Contact</button>
          </div>
        </div>

        <div class="gs-modal-section" style="display:flex; justify-content:flex-end;">
          <button id="gsModalCancelBtn" class="gs-btn gs-btn--ghost" type="button">Close</button>
        </div>

      </div>
    </div>
  </div>

  <!-- ======================================================
       2) CONTACT FORM MODAL (OPENS WHEN CLICK CONTACT BUTTON)
  ======================================================= -->
  <div id="gsContactModal" class="gs-modal" style="display:none;">
    <div class="gs-modal-backdrop" id="gsContactBackdrop"></div>

    <div class="gs-modal-card" role="dialog" aria-modal="true" aria-labelledby="gsContactTitle" style="width:min(620px, 94vw);">
      <div class="gs-modal-head">
        <h3 id="gsContactTitle" style="margin:0;">Send Message</h3>
        <button id="gsContactCloseX" type="button" class="gs-modal-x">✕</button>
      </div>

      <div class="gs-modal-body" style="padding-top:12px;">
        <form id="gsContactForm">
          <input type="hidden" id="gsContactProductId" />
          <input type="hidden" id="gsContactProductTitle" />

          <label class="gs-label">Your Name</label>
          <input class="gs-input" id="gsContactName" required placeholder="Full name" />

          <label class="gs-label">Email</label>
          <input class="gs-input" id="gsContactEmail" type="email" required placeholder="you@example.com" />

          <label class="gs-label">Message</label>
          <textarea class="gs-input" id="gsContactMessage" rows="4" required placeholder="Tell me what you need..."></textarea>

          <div class="gs-form-actions">
            <button id="gsContactSendBtn" class="gs-btn gs-btn--primary" type="submit">Send</button>
            <button id="gsContactCloseBtn" class="gs-btn gs-btn--ghost" type="button">Close</button>
            <span id="gsContactStatus" style="margin-left:auto;opacity:.8;"></span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ======================================================
       UI STYLES (POPUP LOOK + BUTTONS)
       (You can move to styles.css later)
  ======================================================= -->
  <style>
    .gs-btn{
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: #fff;
      cursor: pointer;
      font-weight: 700;
      font-family: Poppins, sans-serif;
      transition: transform .15s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .gs-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.09);
    }
    .gs-btn--primary{
      background: rgba(0,188,212,0.18);
      border-color: rgba(0,188,212,0.35);
    }
    .gs-btn--primary:hover{
      background: rgba(0,188,212,0.24);
      border-color: rgba(0,188,212,0.55);
    }
    .gs-btn--ghost{
      background: rgba(255,255,255,0.05);
    }

    .gs-label{
      display:block;
      margin: 12px 0 6px;
      font-size: 0.95rem;
      opacity: .9;
    }
    .gs-input{
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color:#fff;
      outline:none;
      font-family: Poppins, sans-serif;
    }
    .gs-form-actions{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:14px;
    }

    /* Make project modal bigger */
    .gs-modal-card--big{
      width: min(900px, 94vw);
    }
  </style>

  <!-- Existing scripts -->
  <script src="/script.js"></script>
  <script src="/store-data.js"></script>
  <script type="module" src="/gallery.js"></script>

  <!-- ======================================================
       MODAL JS (AFTER HTML)
  ======================================================= -->
  <script>
  (() => {
    // ===== Elements (Project modal) =====
    const modal = document.getElementById("gsProjectModal");
    const backdrop = document.getElementById("gsModalBackdrop");
    const closeX = document.getElementById("gsModalCloseX");
    const closeBtn = document.getElementById("gsModalCancelBtn");

    const nameEl = document.getElementById("gsModalName");
    const descEl = document.getElementById("gsModalDesc");
    const priceEl = document.getElementById("gsModalPrice");
    const galleryEl = document.getElementById("gsModalGallery");
    const buyBtn = document.getElementById("gsModalBuyBtn");
    const openContactBtn = document.getElementById("gsOpenContactBtn");

    // hidden current project values (kept in memory)
    let currentProject = null;

    // ===== Contact modal =====
    const contactModal = document.getElementById("gsContactModal");
    const contactBackdrop = document.getElementById("gsContactBackdrop");
    const contactCloseX = document.getElementById("gsContactCloseX");
    const contactCloseBtn = document.getElementById("gsContactCloseBtn");

    const cPid = document.getElementById("gsContactProductId");
    const cTitle = document.getElementById("gsContactProductTitle");
    const cStatus = document.getElementById("gsContactStatus");
    const cSendBtn = document.getElementById("gsContactSendBtn");

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function lockScroll(lock){
      document.body.style.overflow = lock ? "hidden" : "";
    }

    function openModal(project){
      currentProject = project || null;
      lockScroll(true);

      const title = project.title || "Untitled";
      nameEl.textContent = title;
      descEl.textContent = project.description || project.desc || "";

      const priceText =
        (project.price === "" || project.price == null || isNaN(Number(project.price)))
          ? "—"
          : `$${Number(project.price).toFixed(2)}`;
      priceEl.textContent = priceText;

      // Images (supports multiple)
      const imgs =
        (Array.isArray(project.images) && project.images.length ? project.images :
        (Array.isArray(project.extra_images) && project.extra_images.length ? project.extra_images : []));

      const fallback = project.cover_image_url || project.image || "/images/hero-image.png";
      const allImgs = imgs.length ? imgs : [fallback];

      galleryEl.innerHTML = allImgs.map(src => `
        <img src="${esc(src)}" alt="${esc(title)}"
             onerror="this.onerror=null;this.src='/images/hero-image.png';" />
      `).join("");

      buyBtn.onclick = () => {
        if (typeof window.addToCart === "function") {
          window.addToCart({
            id: String(project.id || ""),
            title: title,
            price: String(project.price ?? ""),
            category: String(project.category || "")
          });
          if (typeof window.updateCartCount === "function") window.updateCartCount();
          alert("Added to cart ✅");
        } else {
          alert("Cart system not found. (addToCart missing)");
        }
      };

      modal.style.display = "block";
    }

    function closeModal(){
      modal.style.display = "none";
      currentProject = null;
      // Do NOT unlock scroll if contact modal is open
      if (!contactModal || contactModal.style.display !== "block") lockScroll(false);
    }

    function openContactModal(){
      if (!contactModal) return;
      if (!currentProject) return alert("No project selected.");

      cPid.value = currentProject.id || "";
      cTitle.value = currentProject.title || "";

      cStatus.textContent = "";
      cSendBtn.disabled = false;

      contactModal.style.display = "block";
      lockScroll(true);
    }

    function closeContactModal(){
      if (!contactModal) return;
      contactModal.style.display = "none";
      document.getElementById("gsContactForm")?.reset();

      // if main modal still open, keep scroll locked
      if (!modal || modal.style.display !== "block") lockScroll(false);
    }

    // ===== Close handlers (Project modal) =====
    backdrop?.addEventListener("click", closeModal);
    closeX?.addEventListener("click", closeModal);
    closeBtn?.addEventListener("click", closeModal);

    // ===== Close handlers (Contact modal) =====
    openContactBtn?.addEventListener("click", openContactModal);
    contactBackdrop?.addEventListener("click", closeContactModal);
    contactCloseX?.addEventListener("click", closeContactModal);
    contactCloseBtn?.addEventListener("click", closeContactModal);

    // ESC closes top-most modal
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      if (contactModal && contactModal.style.display === "block") return closeContactModal();
      if (modal && modal.style.display === "block") return closeModal();
    });

    async function fetchProjectById(id){
      const res = await fetch("/api/projects", { cache: "no-store" });
      const json = await res.json().catch(() => null);
      if (!json || !json.ok) throw new Error("Cannot load /api/projects");
      const list = json.projects || [];
      return list.find(p => String(p.id) === String(id)) || null;
    }

    // intercept clicks on /project-detail.html?id=... (avoid 404) OR on g-card
    document.addEventListener("click", async (e) => {
      const link = e.target.closest('a[href*="project-detail.html?id="]');
      const card = e.target.closest(".g-card");

      if (!link && !card) return;

      if (link) {
        e.preventDefault();
        e.stopPropagation();
      }

      let id = null;
      if (link) {
        const url = new URL(link.href, location.origin);
        id = url.searchParams.get("id");
      }

      try{
        // If no id, fallback by title match (better: add data-id in gallery.js)
        let p = null;
        if (id) {
          p = await fetchProjectById(id);
        } else {
          const res = await fetch("/api/projects", { cache: "no-store" });
          const json = await res.json().catch(() => null);
          if (!json || !json.ok) return;

          const list = json.projects || [];
          const h = card?.querySelector(".g-title")?.textContent?.trim() || "";
          p = list.find(x => (x.title || "").trim() === h) || null;
        }

        if (!p) return alert("Project not found.");
        openModal(p);
      } catch(err){
        alert("Modal error: " + err.message);
      }
    }, true);

    // Submit contact form -> /api/contact
    document.getElementById("gsContactForm")?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const payload = {
        name: document.getElementById("gsContactName").value.trim(),
        email: document.getElementById("gsContactEmail").value.trim(),
        message: document.getElementById("gsContactMessage").value.trim(),
        productId: cPid.value,
        productTitle: cTitle.value
      };

      if (!payload.name || !payload.email || !payload.message) return;

      cStatus.textContent = "Sending...";
      cSendBtn.disabled = true;

      try{
        const res = await fetch("/api/contact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const out = await res.json().catch(() => ({}));
        if (!res.ok || !out.ok) {
          cStatus.textContent = "Failed";
          cSendBtn.disabled = false;
          return alert("Send failed: " + (out.error || "unknown"));
        }

        cStatus.textContent = "Sent ✅";
        alert("Message sent ✅");
        closeContactModal();
      } catch(err){
        cStatus.textContent = "Failed";
        cSendBtn.disabled = false;
        alert("Network error: " + err.message);
      }
    });

  })();
  </script>

</body>
</html>
